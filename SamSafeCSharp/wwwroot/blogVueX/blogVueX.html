<!DOCTYPE html>
<html>
<head>
    <title>Blog Vue example</title>
</head>
<body>
    <link href="http://getbootstrap.com/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <script src="/scripts/vue.min.js"></script>
    <script src="/scripts/vuex.min.js"></script>
    <script src="/scripts/axios.min.js"></script>

    <div id="blogplaceholder">

        <div class="blog-masthead">
            <div class="container">
                <nav class="blog-nav">
                    <a class="blog-nav-item active" href="#">Home</a>
                    <a class="blog-nav-item" href="http://sam.js.org">About</a>
                </nav>
            </div>
        </div>

        <div class="container">
            <div class="blog-header">
                <h1 class="blog-title" v-once>{{constants.blogTitle}}</h1>
                <p class="lead blog-description" v-once>{{constants.blogDescription}}</p>
            </div>
            <post v-for="post in store.getters.getPosts" :item="post"></post>
            <add-post></add-post>
        </div>
    </div>

    <!-- Templates -->

    <template id="post">
        <div>
            <br>
            <br>
            <h3 class="blog-post-title">{{post.Title}}</h3>
            <p class="blog-post-meta">{{post.Description}}</p>
            <button v-on:click="remove({ 'id': post.Id })">Delete</button>
        </div>
    </template>

    <template id="addpost">
        <div>
            <br>
            <br>
            <div class="mdl-cell mdl-cell--6-col">
                <input v-model="newPostTitle" id="title" type="text" class="form-control" :placeholder="this.$store.getters.getTitleValue"><br>
                <input v-model="newPostDescription" id="description" type="text" class="form-control" :placeholder="this.$store.getters.getDescriptionValue"><br>
                <button id="save" v-on:click="save({ 'title': newPostTitle, 'description': newPostDescription })" v-text="this.$store.getters.getActionLabel"></button>

                <button v-if="this.$store.getters.showCancel" id="cancel" v-on:click="">Cancel</button>

            </div>
        </div>
    </template>

    <script>

        /* Components */

        Vue.component('post', {

            template: '#post',

            props: ['item'],

            data() {
                return {
                    post: this.item
                }
            },

            methods: {
                //Don't rename it to delete it shouldn't work
                remove: function (data) {
                    this.$store.dispatch('delete', data);
                },
            }
        });

        Vue.component('add-post', {

            template: '#addpost',

            data() {
                return {
                    //TODO: Check this
                    newPostTitle: '',
                    newPostDescription: '',
                }
            },

            methods: {

                save: function (data) {
                    this.$store.dispatch('save', data);
                    this.newPostDescription = '';
                    this.newPostTitle = '';
                }
            }

        });

        /* Store */

        const store = new Vuex.Store({

            state: {
                count: 0,

                viewModel: {

                    posts: [],
                    showCancel: false,
                    titleValue: '',
                    descriptionValue: '',
                    id: '',
                    valAttr: '',
                    actionLabel: '',
                    idElement: '',
                    intents: ''
                }
            },

            getters: {

                getPosts: state => {
                    return state.viewModel.posts
                },

                getActionLabel: state => {
                    return state.viewModel.actionLabel
                },

                getTitleValue: state => {
                    return state.viewModel.titleValue
                },

                getDescriptionValue: state => {
                    return state.viewModel.descriptionValue
                },

                getShowCancel: state => {
                    return state.viewModel.showCancel
                }
            },

            actions: {

                initialize({ commit }) {
                    axios.get('http://localhost:2673/api/samsafe/init')
                        .then(response => {
                            commit('updatemodel', response.data);
                        }).catch(e => {
                            console.log('Oops something went wrong!');
                        });
                },

                save({ commit }, data) {  
                    axios.post('http://localhost:2673/api/samsafe/dispatch', { item: data, __action: 'save' },
                        { headers: { 'Content-Type': 'application/json' } })
                        .then(response => {
                            commit('updatemodel', response.data);
                        })
                        .catch(e => {
                            console.log('Oops something went wrong!');
                        });
                },

                delete({ commit }, data) {
                    data.__action = 'delete';
                    axios.post('http://localhost:2673/api/samsafe/dispatch', data,
                        { headers: { 'Content-Type': 'application/json' } })
                        .then(response => {
                            commit('updatemodel', response.data);
                        })
                        .catch(e => {
                            console.log('Oops something went wrong!');
                        });
                },

            },

            mutations: {

                updatemodel(state, data) {
                    state.viewModel = data;
                },
             
            }
        });

        /* Starting app */

        let vue = new Vue({

            el: '#blogplaceholder',

            store,

            data: {
                constants: {
                    blogTitle: 'The SAM Pattern Blog',
                    blogDescription: 'The official blog sample impleting the SAM Pattern',
                },
            },

            created: function () {
                this.$store.dispatch('initialize') 
            },
          
        });

    </script>
</body>
</html>