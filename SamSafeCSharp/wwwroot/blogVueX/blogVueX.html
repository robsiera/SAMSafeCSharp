<!DOCTYPE html>
<html>
<head>
    <title>Blog Vue example</title>
</head>
<body>
    <link href="http://getbootstrap.com/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <script src="/scripts/vue.min.js"></script>
    <script src="/scripts/vuex.min.js"></script>
    <script src="/scripts/axios.min.js"></script>

    <div id="blogplaceholder">

        <div class="blog-masthead">
            <div class="container">
                <nav class="blog-nav">
                    <a class="blog-nav-item active" href="#">Home</a>
                    <a class="blog-nav-item" href="http://sam.js.org">About</a>
                </nav>
            </div>
        </div>

        <div class="container">
            <div class="blog-header">
                <h1 class="blog-title" v-once>{{constants.blogTitle}}</h1>
                <p class="lead blog-description" v-once>{{constants.blogDescription}}</p>
            </div>
            <post v-for="post in viewModel.posts" :item="post"></post>
            <add-post :model="viewModel"></add-post>
        </div>
    </div>

    <!-- Templates -->

    <template id="post">
        <div>
            <br>
            <br>
            <h3 class="blog-post-title">{{post.Title}}</h3>
            <p class="blog-post-meta">{{post.Description}}</p>
            <button v-on:click="remove({ 'id': post.Id })">Delete</button>
        </div>
    </template>

    <template id="addpost">
        <div>
            <br>
            <br>
            <div class="mdl-cell mdl-cell--6-col">
                <input v-model="newPostTitle" id="title" type="text" class="form-control" :placeholder="viewModel.titleValue"><br>
                <input v-model="newPostDescription" id="description" type="text" class="form-control" :placeholder="viewModel.descriptionValue"><br>
                <button id="save" v-on:click="save({ 'title': newPostTitle, 'description': newPostDescription })" v-text="viewModel.actionLabel"></button>

                <button v-if="viewModel.showCancel" id="cancel" v-on:click="">Cancel</button>

            </div>
        </div>
    </template>

    <script>

        /* Components */

        Vue.component('post', {

            template: '#post',

            props: ['item'],

            data() {
                return {
                    post: this.item
                }
            },

            methods: {

                remove: function (data) {
                    data.__action = 'delete';
                    this.handle(data);
                    return false;
                },
            }
        });

        Vue.component('add-post', {

            template: '#addpost',

            props: ['model'],

            data() {
                return {

                    newPostTitle: '',
                    newPostDescription: '',
                    viewModel: this.model

                }
            },

            methods: {

                save: function (data) {
                    var proposal = { item: data };
                    proposal.__action = 'save';
                    this.handle(proposal);
                    this.newPostTitle = '';
                    this.newPostDescription = '';
                    return false;
                }
            }

        });

        /* Starting app */

        let vue = new Vue({

            el: '#blogplaceholder',

            // Model
            data: {
                constants: {
                    blogTitle: 'The SAM Pattern Blog',
                    blogDescription: 'The official blog sample impleting the SAM Pattern'
                },

                samVariantToUse: 'server',

                endpoint: 'http://localhost:2673',

                viewModel: {

                    posts: [
                    ],
                    showCancel: false,
                    titleValue: '',
                    descriptionValue: '',
                    id: '',
                    valAttr: '',
                    actionLabel: '',
                    idElement: '',
                    intents: ''
                }
            },

            created: function () {

                // `this` points to the vm instance
                if (this.samVariantToUse === 'client') {
                    // client side
                    view.display(view.init(this.viewModel));
                }
                else if (this.samVariantToUse === 'server') {
                    // server side
                    this.handle = this.dispatch;  // set the handler of the actions the dispatcher function.
                    var viewModel = this.viewModel;

                    axios.get(this.endpoint + '/api/samsafe/init')
                        .then(response => {
                            // JSON responses are automatically parsed.
                            viewModel.posts = response.data.posts;
                            viewModel.showCancel = response.data.showCancel;
                            viewModel.titleValue = response.data.titleValue;
                            viewModel.descriptionValue = response.data.descriptionValue;
                            viewModel.id = response.data.id;
                            viewModel.valAttr = response.data.valAttr;
                            viewModel.actionLabel = response.data.actionLabel;
                            viewModel.idElement = response.data.idElement;
                            viewModel.intents = response.data.intents;
                            console.log(viewModel.posts);
                        })
                        .catch(e => {
                            console.log('Oops something went wrong!');
                        });
                    console.log(viewModel.posts);
                }
            },

            methods: {

                dispatch: function (data) {

                    if (this.samVariantToUse === 'client') {
                        // client side
                        model.present(data);
                    }
                    else if (this.samVariantToUse === 'server') {
                        // server side

                        var model = this.viewModel;

                        axios.post(this.endpoint + '/api/samsafe/dispatch', data,
                            { headers: { 'Content-Type': 'application/json' } })
                            .then(response => {
                                // JSON responses are automatically parsed.
                                model.posts = response.data.posts;
                                model.showCancel = response.data.showCancel;
                                model.titleValue = response.data.titleValue;
                                model.descriptionValue = response.data.descriptionValue;
                                model.id = response.data.id;
                                model.valAttr = response.data.valAttr;
                                model.actionLabel = response.data.actionLabel;
                                model.idElement = response.data.idElement;
                                model.intents = response.data.intents;
                            })
                            .catch(e => {
                                console.log('Oops something went wrong!');
                            });
                    }
                }
            }
        });

    </script>
</body>
</html>